CURRENT_DATE: 2026-02-07

############################################################
#  FormatterAgent Prompt – McKinsey-Grade Reports
#  Role  : Formats final results into exhaustive HTML reports
#  Output: JSON with final_format in a detailed markdown_report
############################################################

You are the **FORMATTERAGENT**.
Your job is to **generate a consulting-grade final report** using ALL available data.
This is the **final user-facing artifact**.

---

## ✅ INPUTS
- `agent_prompt`: Formatting instructions
- `all_globals_schema`: The **complete session-wide data** (your core source of truth for generating content)
- `session_context`: Metadata & **Memory Context** (contains user-specific facts/answers)

## ✅ STRATEGY
1. **Consulting-Grade Output**: Simulate McKinsey/BCG depth. 12-20 sections if data allows.
2. **Deep Integration**: Mine `_T###` fields in `all_globals_schema`.
3. **Execution**: Return pure Markdown in a specific structure.

## ✅ ADAPTIVE DEPTH & RECURSION
**You must be SMART about the report size.**
1.  **Simple/Factual Queries** (e.g., "Where do I stay?", "What is 2+2?", "Stock price of Apple?"):
    -   **ACTION**: Generate a **concise, direct answer**.
    -   **FORMAT**: Small Markdown block. No massive Executive Summary or Table of Contents needed.
    -   **ACTION**: Generate a **massive, exhaustive report**.
    -   **FORCE DEPTH (Washington Post Standard)**:
        -   **Context**: "It is being run for the Washington Post, so expect that kind of detailed 4-5k words report at minimum, if required then upto 16k report as well. We are being paid $2000 for this report so don't be brief."
        -   **Instruction**: If the data allows, specific sections should be 500+ words.
        -   **OVERRIDE MANDATE**: If the specific task instruction asks for a "concise summary" or "brief overview", **YOU MUST IGNORE THAT INSTRUCTION** if the input data is large (>5000 tokens). Assume the user wants DEPTH unless explicitly stated otherwise in the *original query*.
        -   **RECURSION MANDATE**: For these high-stakes reports, you CANNOT finish in one step.

            -   **Set `"call_self": true`** in your first iteration.
            -   Focus your first iteration *only* on the first 2-3 major sections (e.g., Executive Summary, Market Overview).
            -   Return the partial Markdown. The system will call you again to finish.
    -   **RECURSION**: If the data in `all_globals_schema` is huge and requires multiple steps to format (e.g., >5000 words), you can split the work:
        -   Set `"call_self": true` to continue formatting in the next step.
        -   Return the *partial* report in the current key.
    -   **FORMAT**: Full McKinsey style. Use tables, h1-h4, detailed analysis.

## ✅ CRITICAL GUIDELINES
- **Specific Subjects in Titles**: The report MUST have a main title (H1) that explicitly includes the **specific subject name** based on the data.
### 2. DATA SOURCE HIERARCHY & EXPANSION
You have access to two primary data sources:
1.  **`all_globals_schema` (Task Data)**: Contains ALL outputs from previous agents (search results, raw content, intermediate summaries).
2.  **`session_context['memory_context']` (User Context)**: Contains user preferences and long-term memories.

**CRITICAL INSTRUCTION ON DATA USAGE:**
- **NEVER rely solely on downstream summaries** (e.g., "key_insights", "summary_T005") for complex reports. These are often lossy and too brief.
- **YOU MUST DIVE DEEP** into the `all_globals_schema` to find the **raw execution results** (e.g., `web_search_results`, `crawled_pages`, `detailed_analysis`).
- **EXPAND** the points found in summaries using this raw data. If a summary says "Market is growing", find the exact numbers, CAGR, and quotes from the raw search results in `all_globals_schema` to back it up.

### 3. HOW TO WRITE DEEP CONTENT (For Complex Queries)
When `FORCE DEPTH` is active (for complex/large reports):
1.  **NO "Bullet-Point Only" Sections**: Bullet points are for lists. Analysis must be in **full paragraphs** (5-8 sentences each).
2.  **INTEGRATE DATA**: Every claim must be backed by a specific datapoint from `all_globals_schema`.
    -   *Bad*: "The market is growing."
    -   *Good*: "According to the Mordor Intelligence report (T003), the market is projected to reach $564M by FY29, driven by a 17.9% CAGR."
3.  **QUOTE THE SOURCE**: Extract direct quotes from `crawled_pages` or `search_results`.
4.  **ITERATE THE SCHEMA**: Do not just look at `summary_T###`. Look at `web_search_results_T###` and `detailed_analysis_T###`. extract the "nuggets" that the summary skipped.
- **Task Data > User Context**: If Task Data contains verified, recent facts that contradict `memory_context`, prioritize the Task Data.
- **User Context for Personalization**: Use `memory_context` to tailor the *tone*, *format*, and *focus* (e.g., "User prefers simple language" or "User loves tabular data").
- **Conflict Rule**: If Task Data explicitly contradicts Memory with *newer* verification (e.g. "User verified they now work at Google"), trust Task Data. Otherwise, trust Memory for user facts.
- **ANTI-HALLUCINATION**: If neither source has the answer, state "No Data Available".
- **Tone**: Professional, actionable, high-trust.

---

## ✅ OUTPUT FORMAT (JSON)
You must return a JSON object like:
```json
{
  "final_format": "markdown",
  "markdown_report": "Detailed markdown report",
  "call_self": true
}
```

## ✅ OUTPUT VARIABLE NAMING
**CRITICAL**: Use the exact variable names from "writes" field for your report key.
---
## User Preferences
User prefers: concise responses
Clarifications: minimize
Tone: no_motivational, direct
Avoid: It's not this, it's this, What you're describing is not
---


```json
{
  "step_id": "T004",
  "agent_prompt": "Create a detailed and comprehensive report based on the `synthesized_findings_T003`. Organize the report logically, using headings, subheadings, and bullet points for clarity. Include a summary of all documents analyzed, key themes, identified entities, important dates, and significant numerical data. The report should be formatted in Markdown, aiming for a detailed output suitable for executive review.",
  "reads": [
    "synthesized_findings_T003"
  ],
  "writes": [
    "comprehensive_report_T004"
  ],
  "inputs": {
    "synthesized_findings_T003": {
      "summary": "Analysis of the provided documents could not be completed due to errors reaching the AI model for all text-extractable files. Unsupported file types were also encountered.",
      "documents_processed": {
        "Bill _Stay at Hotel Ocean Suites.pdf": "Analysis failed: Error: Could not reach the AI model for this document query. (400 Client Error: Bad Request for url: http://127.0.0.1:11434/api/chat)",
        "CLAIM DETAILS OF MONISHA SRIVASTAVA .xlsx": "Analysis failed: Error: Could not reach the AI model for this document query. (400 Client Error: Bad Request for url: http://127.0.0.1:11434/api/chat)",
        "CLAIM DETAILS OF MONISHA SRIVASTAVA .xlsx - Google Sheets.pdf": "Analysis failed: Error: Could not reach the AI model for this document query. (400 Client Error: Bad Request for url: http://127.0.0.1:11434/api/chat)",
        "demo1.mp4": "Unsupported file type",
        "IMG_20180421_110010_cropped.JPG": "Unsupported file type",
        "Monisha Resume Revised _ DND(SDG).pdf": "Analysis failed: Error: Could not reach the AI model for this document query. (400 Client Error: Bad Request for url: http://127.0.0.1:11434/api/chat)",
        "p2.jpg": "Unsupported file type",
        "Receipt 1 _ Uber From Home To IGI T-1D.pdf": "Analysis failed: Error: Could not reach the AI model for this document query. (400 Client Error: Bad Request for url: http://127.0.0.1:11434/api/chat)",
        "Receipt 2 _ Payment Against  Stay  At  Hotel Ocean  Suites.png": "Unsupported file type",
        "Receipt 3. Auto From Hotel to L&T Powai .jpeg": "Unsupported file type",
        "Receipt 4 _ Uber From L&T Powai To BOM AIRPORT.pdf": "Analysis failed: Error: Could not reach the AI model for this document query. (400 Client Error: Bad Request for url: http://127.0.0.1:11434/api/chat)",
        "Receipt 5 _ Air Tickets From DEL To BOM and Vice versa.pdf": "Analysis failed: Error: Could not reach the AI model for this document query. (400 Client Error: Bad Request for url: http://127.0.0.1:11434/api/chat)",
        "Receipt 6 _ Uber From IGI T-1C TO Home.pdf": "Analysis failed: Error: Could not reach the AI model for this document query. (400 Client Error: Bad Request for url: http://127.0.0.1:11434/api/chat)"
      },
      "key_themes": [],
      "entities": [],
      "numerical_data": [],
      "dates": []
    }
  },
  "original_query": "Analyze all documents in my folder C:\\Users\\Monisha Srivastava\\Desktop\\L&T POWAI 27-28 NOV 24",
  "session_context": {
    "session_id": "70450991",
    "created_at": "2026-02-07T07:56:31.765147",
    "file_manifest": [],
    "memory_context": null
  },
  "all_globals_schema": {
    "file_list_T001": [
      {
        "name": "Bill _Stay at Hotel Ocean Suites.pdf",
        "size": 2255396,
        "type": "File"
      },
      {
        "name": "CLAIM DETAILS OF MONISHA SRIVASTAVA .xlsx",
        "size": 27401,
        "type": "File"
      },
      {
        "name": "CLAIM DETAILS OF MONISHA SRIVASTAVA .xlsx - Google Sheets.pdf",
        "size": 74394,
        "type": "File"
      },
      {
        "name": "demo1.mp4",
        "size": 8883753,
        "type": "File"
      },
      {
        "name": "IMG_20180421_110010_cropped.JPG",
        "size": 1838348,
        "type": "File"
      },
      {
        "name": "Monisha Resume Revised _ DND(SDG).pdf",
        "size": 4017349,
        "type": "File"
      },
      {
        "name": "p2.jpg",
        "size": 34406,
        "type": "File"
      },
      {
        "name": "Receipt 1 _ Uber From Home To IGI T-1D.pdf",
        "size": 28964,
        "type": "File"
      },
      {
        "name": "Receipt 2 _ Payment Against  Stay  At  Hotel Ocean  Suites.png",
        "size": 116752,
        "type": "File"
      },
      {
        "name": "Receipt 3. Auto From Hotel to L&T Powai .jpeg",
        "size": 139654,
        "type": "File"
      },
      {
        "name": "Receipt 4 _ Uber From L&T Powai To BOM AIRPORT.pdf",
        "size": 27705,
        "type": "File"
      },
      {
        "name": "Receipt 5 _ Air Tickets From DEL To BOM and Vice versa.pdf",
        "size": 537352,
        "type": "File"
      },
      {
        "name": "Receipt 6 _ Uber From IGI T-1C TO Home.pdf",
        "size": 29143,
        "type": "File"
      }
    ],
    "document_analysis_results_T002": {
      "Bill _Stay at Hotel Ocean Suites.pdf": {
        "topics": "Error: Could not reach the AI model for this document query. (400 Client Error: Bad Request for url: http://127.0.0.1:11434/api/chat)",
        "entities": "Error: Could not reach the AI model for this document query. (400 Client Error: Bad Request for url: http://127.0.0.1:11434/api/chat)",
        "dates": "Error: Could not reach the AI model for this document query. (400 Client Error: Bad Request for url: http://127.0.0.1:11434/api/chat)",
        "numerical_data": "Error: Could not reach the AI model for this document query. (400 Client Error: Bad Request for url: http://127.0.0.1:11434/api/chat)"
      },
      "CLAIM DETAILS OF MONISHA SRIVASTAVA .xlsx": {
        "topics": "Error: Could not reach the AI model for this document query. (400 Client Error: Bad Request for url: http://127.0.0.1:11434/api/chat)",
        "entities": "Error: Could not reach the AI model for this document query. (400 Client Error: Bad Request for url: http://127.0.0.1:11434/api/chat)",
        "dates": "Error: Could not reach the AI model for this document query. (400 Client Error: Bad Request for url: http://127.0.0.1:11434/api/chat)",
        "numerical_data": "Error: Could not reach the AI model for this document query. (400 Client Error: Bad Request for url: http://127.0.0.1:11434/api/chat)"
      },
      "CLAIM DETAILS OF MONISHA SRIVASTAVA .xlsx - Google Sheets.pdf": {
        "topics": "Error: Could not reach the AI model for this document query. (400 Client Error: Bad Request for url: http://127.0.0.1:11434/api/chat)",
        "entities": "Error: Could not reach the AI model for this document query. (400 Client Error: Bad Request for url: http://127.0.0.1:11434/api/chat)",
        "dates": "Error: Could not reach the AI model for this document query. (400 Client Error: Bad Request for url: http://127.0.0.1:11434/api/chat)",
        "numerical_data": "Error: Could not reach the AI model for this document query. (400 Client Error: Bad Request for url: http://127.0.0.1:11434/api/chat)"
      },
      "demo1.mp4": {
        "type": "unsupported",
        "message": "File type not supported for text extraction"
      },
      "IMG_20180421_110010_cropped.JPG": {
        "type": "unsupported",
        "message": "File type not supported for text extraction"
      },
      "Monisha Resume Revised _ DND(SDG).pdf": {
        "topics": "Error: Could not reach the AI model for this document query. (400 Client Error: Bad Request for url: http://127.0.0.1:11434/api/chat)",
        "entities": "Error: Could not reach the AI model for this document query. (400 Client Error: Bad Request for url: http://127.0.0.1:11434/api/chat)",
        "dates": "Error: Could not reach the AI model for this document query. (400 Client Error: Bad Request for url: http://127.0.0.1:11434/api/chat)",
        "numerical_data": "Error: Could not reach the AI model for this document query. (400 Client Error: Bad Request for url: http://127.0.0.1:11434/api/chat)"
      },
      "p2.jpg": {
        "type": "unsupported",
        "message": "File type not supported for text extraction"
      },
      "Receipt 1 _ Uber From Home To IGI T-1D.pdf": {
        "topics": "Error: Could not reach the AI model for this document query. (400 Client Error: Bad Request for url: http://127.0.0.1:11434/api/chat)",
        "entities": "Error: Could not reach the AI model for this document query. (400 Client Error: Bad Request for url: http://127.0.0.1:11434/api/chat)",
        "dates": "Error: Could not reach the AI model for this document query. (400 Client Error: Bad Request for url: http://127.0.0.1:11434/api/chat)",
        "numerical_data": "Error: Could not reach the AI model for this document query. (400 Client Error: Bad Request for url: http://127.0.0.1:11434/api/chat)"
      },
      "Receipt 2 _ Payment Against  Stay  At  Hotel Ocean  Suites.png": {
        "type": "unsupported",
        "message": "File type not supported for text extraction"
      },
      "Receipt 3. Auto From Hotel to L&T Powai .jpeg": {
        "type": "unsupported",
        "message": "File type not supported for text extraction"
      },
      "Receipt 4 _ Uber From L&T Powai To BOM AIRPORT.pdf": {
        "topics": "Error: Could not reach the AI model for this document query. (400 Client Error: Bad Request for url: http://127.0.0.1:11434/api/chat)",
        "entities": "Error: Could not reach the AI model for this document query. (400 Client Error: Bad Request for url: http://127.0.0.1:11434/api/chat)",
        "dates": "Error: Could not reach the AI model for this document query. (400 Client Error: Bad Request for url: http://127.0.0.1:11434/api/chat)",
        "numerical_data": "Error: Could not reach the AI model for this document query. (400 Client Error: Bad Request for url: http://127.0.0.1:11434/api/chat)"
      },
      "Receipt 5 _ Air Tickets From DEL To BOM and Vice versa.pdf": {
        "topics": "Error: Could not reach the AI model for this document query. (400 Client Error: Bad Request for url: http://127.0.0.1:11434/api/chat)",
        "entities": "Error: Could not reach the AI model for this document query. (400 Client Error: Bad Request for url: http://127.0.0.1:11434/api/chat)",
        "dates": "Error: Could not reach the AI model for this document query. (400 Client Error: Bad Request for url: http://127.0.0.1:11434/api/chat)",
        "numerical_data": "Error: Could not reach the AI model for this document query. (400 Client Error: Bad Request for url: http://127.0.0.1:11434/api/chat)"
      },
      "Receipt 6 _ Uber From IGI T-1C TO Home.pdf": {
        "topics": "Error: Could not reach the AI model for this document query. (400 Client Error: Bad Request for url: http://127.0.0.1:11434/api/chat)",
        "entities": "Error: Could not reach the AI model for this document query. (400 Client Error: Bad Request for url: http://127.0.0.1:11434/api/chat)",
        "dates": "Error: Could not reach the AI model for this document query. (400 Client Error: Bad Request for url: http://127.0.0.1:11434/api/chat)",
        "numerical_data": "Error: Could not reach the AI model for this document query. (400 Client Error: Bad Request for url: http://127.0.0.1:11434/api/chat)"
      }
    },
    "synthesized_findings_T003": {
      "summary": "Analysis of the provided documents could not be completed due to errors reaching the AI model for all text-extractable files. Unsupported file types were also encountered.",
      "documents_processed": {
        "Bill _Stay at Hotel Ocean Suites.pdf": "Analysis failed: Error: Could not reach the AI model for this document query. (400 Client Error: Bad Request for url: http://127.0.0.1:11434/api/chat)",
        "CLAIM DETAILS OF MONISHA SRIVASTAVA .xlsx": "Analysis failed: Error: Could not reach the AI model for this document query. (400 Client Error: Bad Request for url: http://127.0.0.1:11434/api/chat)",
        "CLAIM DETAILS OF MONISHA SRIVASTAVA .xlsx - Google Sheets.pdf": "Analysis failed: Error: Could not reach the AI model for this document query. (400 Client Error: Bad Request for url: http://127.0.0.1:11434/api/chat)",
        "demo1.mp4": "Unsupported file type",
        "IMG_20180421_110010_cropped.JPG": "Unsupported file type",
        "Monisha Resume Revised _ DND(SDG).pdf": "Analysis failed: Error: Could not reach the AI model for this document query. (400 Client Error: Bad Request for url: http://127.0.0.1:11434/api/chat)",
        "p2.jpg": "Unsupported file type",
        "Receipt 1 _ Uber From Home To IGI T-1D.pdf": "Analysis failed: Error: Could not reach the AI model for this document query. (400 Client Error: Bad Request for url: http://127.0.0.1:11434/api/chat)",
        "Receipt 2 _ Payment Against  Stay  At  Hotel Ocean  Suites.png": "Unsupported file type",
        "Receipt 3. Auto From Hotel to L&T Powai .jpeg": "Unsupported file type",
        "Receipt 4 _ Uber From L&T Powai To BOM AIRPORT.pdf": "Analysis failed: Error: Could not reach the AI model for this document query. (400 Client Error: Bad Request for url: http://127.0.0.1:11434/api/chat)",
        "Receipt 5 _ Air Tickets From DEL To BOM and Vice versa.pdf": "Analysis failed: Error: Could not reach the AI model for this document query. (400 Client Error: Bad Request for url: http://127.0.0.1:11434/api/chat)",
        "Receipt 6 _ Uber From IGI T-1C TO Home.pdf": "Analysis failed: Error: Could not reach the AI model for this document query. (400 Client Error: Bad Request for url: http://127.0.0.1:11434/api/chat)"
      },
      "key_themes": [],
      "entities": [],
      "numerical_data": [],
      "dates": []
    }
  }
}
```